<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnson Prototype - Test Execution</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a2e;
            color: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #533a7b;
            border-radius: 8px;
            background-color: #16213e;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #d73450;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .log {
            background-color: #0f3460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Johnson Prototype - Execution Test</h1>

    <div class="test-section">
        <h2>Game State Initialization Test</h2>
        <button onclick="testGameStateInit()">Test Game State</button>
        <button onclick="testSessionStorage()">Test Session Storage</button>
        <div id="init-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Contract Execution Test</h2>
        <button onclick="setupTestContract()">Setup Test Contract</button>
        <button onclick="testContractExecution()" id="execute-test" disabled>Execute Test Contract</button>
        <div id="execution-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Full Game Loop Test</h2>
        <button onclick="runFullGameLoopTest()">Run Complete Game Loop</button>
        <div id="gameloop-log" class="log"></div>
    </div>

    <script src="Tools/node_modules/papaparse/papaparse.min.js"></script>
    <script src="js/csvLoader.js"></script>
    <script src="js/gameState.js"></script>
    <script>
        let gameState = null;
        let csvLoader = null;

        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            element.scrollTop = element.scrollHeight;
        }

        function testGameStateInit() {
            try {
                gameState = new GameState();
                log('init-log', 'GameState initialized successfully');

                // Test runner configuration
                gameState.setRunnerType(0, 'Face');
                gameState.setRunnerStat(0, 'face', 5);
                log('init-log', 'Runner configuration test passed');

                // Test pool calculation
                const pools = gameState.calculateCurrentPools();
                log('init-log', 'Pool calculation test passed: ' + JSON.stringify(pools));

            } catch (error) {
                log('init-log', 'ERROR: ' + error.message);
            }
        }

        function testSessionStorage() {
            try {
                if (!gameState) {
                    log('init-log', 'ERROR: Initialize game state first');
                    return;
                }

                // Save session state
                gameState.saveSessionState();
                log('init-log', 'Session state saved');

                // Create new game state and load session
                const newGameState = new GameState();
                const loaded = newGameState.loadSessionState();
                log('init-log', 'Session state loaded: ' + loaded);

                if (loaded) {
                    log('init-log', 'Session restore test passed');
                } else {
                    log('init-log', 'Session restore test failed');
                }

            } catch (error) {
                log('init-log', 'ERROR: ' + error.message);
            }
        }

        function setupTestContract() {
            try {
                if (!gameState) {
                    gameState = new GameState();
                    log('execution-log', 'GameState initialized');
                }

                // Create test contract data
                const testContractData = [
                    {
                        'Node ID': '1',
                        'Description': 'Start Node',
                        'Effect Desc': '+2 Grit',
                        'Effect 1': 'None;+;2;Grit',
                        'Effect 2': '',
                        'Type': 'Effect',
                        'Color': 'Red',
                        'Layer': '0',
                        'Slot': 'CE',
                        'Connections': '2;3'
                    },
                    {
                        'Node ID': '2',
                        'Description': 'Money Node',
                        'Effect Desc': '+100 Money',
                        'Effect 1': 'None;+;100;Money',
                        'Effect 2': '',
                        'Type': 'Effect',
                        'Color': 'Green',
                        'Layer': '1',
                        'Slot': 'U1',
                        'Connections': ''
                    }
                ];

                gameState.setContractData(testContractData);
                log('execution-log', 'Test contract data loaded');

                // Select nodes for testing
                gameState.selectNode('1');
                gameState.selectNode('2');
                log('execution-log', 'Test nodes selected');

                // Configure test runners
                gameState.setRunnerType(0, 'Face');
                gameState.setRunnerStat(0, 'face', 5);
                log('execution-log', 'Test runner configured');

                // Enable execution button
                document.getElementById('execute-test').disabled = false;
                log('execution-log', 'Ready for execution test');

            } catch (error) {
                log('execution-log', 'ERROR: ' + error.message);
            }
        }

        function testContractExecution() {
            try {
                if (!gameState || !gameState.contractData) {
                    log('execution-log', 'ERROR: Setup test contract first');
                    return;
                }

                log('execution-log', 'Starting contract execution...');

                const executionResults = gameState.executeContract();

                log('execution-log', 'Execution completed successfully!');
                log('execution-log', 'Success: ' + executionResults.success);
                log('execution-log', 'Money earned: $' + executionResults.moneyEarned);
                log('execution-log', 'Final damage: ' + executionResults.finalDamage);
                log('execution-log', 'Final risk: ' + executionResults.finalRisk);
                log('execution-log', 'Prevention: ' + executionResults.preventionApplied);
                log('execution-log', 'Execution time: ' + executionResults.executionTime.toFixed(2) + 'ms');

            } catch (error) {
                log('execution-log', 'ERROR: ' + error.message);
            }
        }

        function runFullGameLoopTest() {
            try {
                log('gameloop-log', 'Starting full game loop test...');

                // Step 1: Initialize
                gameState = new GameState();
                log('gameloop-log', '1. Game state initialized');

                // Step 2: Load contract
                const testContractData = [
                    {
                        'Node ID': '1',
                        'Description': 'Start Node',
                        'Effect Desc': '+2 Grit, +50 Money',
                        'Effect 1': 'None;+;2;Grit',
                        'Effect 2': 'None;+;50;Money',
                        'Type': 'Effect',
                        'Color': 'Red',
                        'Layer': '0',
                        'Slot': 'CE',
                        'Connections': '2'
                    },
                    {
                        'Node ID': '2',
                        'Description': 'Risk Node',
                        'Effect Desc': '+3 Risk, +100 Money',
                        'Effect 1': 'None;+;3;Risk',
                        'Effect 2': 'None;+;100;Money',
                        'Type': 'Effect',
                        'Color': 'Yellow',
                        'Layer': '1',
                        'Slot': 'CE',
                        'Connections': ''
                    }
                ];

                gameState.setContractData(testContractData);
                log('gameloop-log', '2. Contract loaded');

                // Step 3: Configure runners
                gameState.setRunnerType(0, 'Face');
                gameState.setRunnerStat(0, 'face', 7);
                gameState.setRunnerType(1, 'Muscle');
                gameState.setRunnerStat(1, 'muscle', 4);
                log('gameloop-log', '3. Runners configured');

                // Step 4: Select nodes
                gameState.selectNode('1');
                gameState.selectNode('2');
                log('gameloop-log', '4. Nodes selected');

                // Step 5: Validate configuration
                const isValid = gameState.validateConfiguration();
                log('gameloop-log', '5. Configuration validated: ' + isValid);

                // Step 6: Execute contract
                const executionResults = gameState.executeContract();
                log('gameloop-log', '6. Contract executed successfully!');

                // Step 7: Display results
                log('gameloop-log', '=== EXECUTION RESULTS ===');
                log('gameloop-log', 'Success: ' + executionResults.success);
                log('gameloop-log', 'Money earned: $' + executionResults.moneyEarned);
                log('gameloop-log', 'Total money: $' + executionResults.postExecution.money);
                log('gameloop-log', 'Total risk: ' + executionResults.postExecution.risk);
                log('gameloop-log', 'Contracts completed: ' + executionResults.postExecution.contracts);
                log('gameloop-log', 'Prevention applied: ' + executionResults.preventionApplied);

                // Step 8: Test reset
                gameState.resetContract();
                log('gameloop-log', '7. Contract reset for next run');

                log('gameloop-log', '=== FULL GAME LOOP TEST COMPLETED SUCCESSFULLY ===');

            } catch (error) {
                log('gameloop-log', 'ERROR: ' + error.message);
                console.error(error);
            }
        }

        // Auto-run basic initialization test
        window.addEventListener('load', function() {
            log('init-log', 'Test page loaded, ready for testing');
        });
    </script>
</body>
</html>